name: Test GitHub App Token

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Check secrets exist
        run: |
          echo "APP_ID is set: ${{ vars.APP_ID != '' }}"
          echo "APP_ID value: ${{ vars.APP_ID }}"
          echo "APP_PRIVATE_KEY is set: ${{ secrets.APP_PRIVATE_KEY != '' }}"

      - name: Generate token from GitHub App
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: shamansoft
          repositories: kukbuk-srv

      - name: Debug - Check token output
        run: |
          echo "Token output exists: ${{ steps.app-token.outputs.token != '' }}"
          TOKEN="${{ steps.app-token.outputs.token }}"
          echo "Token length: ${#TOKEN}"
          echo "Token prefix: ${TOKEN:0:10}..."

          # Check if it looks like a JWT (starts with ghs_ or v1.)
          if [[ "$TOKEN" == ghs_* ]]; then
            echo "⚠️ Token looks like a GitHub secret token (ghs_)"
          elif [[ "$TOKEN" == ghp_* ]]; then
            echo "⚠️ Token looks like a Personal Access Token (ghp_)"
          elif [[ "$TOKEN" == v1.* ]]; then
            echo "✅ Token looks like a GitHub App token (v1.)"
          else
            echo "❓ Unknown token format"
          fi

      - name: Test token - Get authenticated user
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Testing: GET /user"
          gh api /user --jq '{login, type}' || echo "❌ Failed to get user"

      - name: Test token - Check installation
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Testing: GET /repos/shamansoft/kukbuk-srv/installation"
          gh api /repos/shamansoft/kukbuk-srv/installation --jq '{app_slug, account_login, target_type}' || echo "❌ Failed to get installation"

      - name: Test token - List repo contents
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "Testing: GET /repos/shamansoft/kukbuk-srv/contents"
          gh api /repos/shamansoft/kukbuk-srv/contents --jq 'length' || echo "❌ Failed to list contents"

      - name: Summary
        if: always()
        run: |
          echo "If all tests passed, the app is configured correctly!"
          echo "If tests failed, check the errors above for clues."
