name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/deployment-setup.md'

env:
  JAVA_VERSION: '21'

# Allow only one validation per PR at a time
concurrency:
  group: pr-validation-${{ github.event.pull_request.number }}
  cancel-in-progress: true  # Cancel old runs when new commits pushed

jobs:
  validate:
    name: Validate Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better diff analysis

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # Validation Phase
    - name: Run unit tests
      run: |
        echo "::group::Unit Tests"
        ./gradlew :cookbook:test --no-daemon --console=plain
        echo "::endgroup::"

    - name: Run integration tests
      run: |
        echo "::group::Integration Tests"
        ./gradlew :cookbook:intTest --no-daemon --console=plain
        echo "::endgroup::"

    - name: Check code coverage
      run: |
        echo "::group::Code Coverage Check (40% minimum)"
        ./gradlew :cookbook:checkCoverage --no-daemon --console=plain
        echo "::endgroup::"

    - name: Security vulnerability scan
      run: |
        echo "::group::OWASP Dependency Check"
        ./gradlew :cookbook:dependencyCheckAnalyze --no-daemon --console=plain
        echo "::endgroup::"

    # Publish test results
    - name: Publish test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-test-results
        path: |
          extractor/build/reports/tests/
          extractor/build/test-results/

    - name: Publish coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-coverage-reports
        path: extractor/build/reports/jacoco/

    - name: Publish security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-security-reports
        path: extractor/build/reports/dependency-check/

    # Comment on PR with coverage
    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: madrapps/jacoco-report@v1.6.1
      with:
        paths: |
          ${{ github.workspace }}/extractor/build/reports/jacoco/test/jacocoTestReport.xml
        token: ${{ secrets.GITHUB_TOKEN }}
        min-coverage-overall: 40
        min-coverage-changed-files: 60
        title: Code Coverage Report
        update-comment: true

    # Comment on PR with security scan results
    - name: Parse security scan results
      if: github.event_name == 'pull_request' && always()
      id: security-summary
      run: |
        REPORT_FILE="extractor/build/reports/dependency-check/dependency-check-report.json"

        if [ ! -f "$REPORT_FILE" ]; then
          echo "No security report found"
          echo "summary=No security report generated" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Parse JSON report for vulnerabilities
        CRITICAL=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "CRITICAL")] | length' "$REPORT_FILE" || echo 0)
        HIGH=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")] | length' "$REPORT_FILE" || echo 0)
        MEDIUM=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "MEDIUM")] | length' "$REPORT_FILE" || echo 0)
        LOW=$(jq '[.dependencies[]?.vulnerabilities[]? | select(.severity == "LOW")] | length' "$REPORT_FILE" || echo 0)

        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
        echo "low=$LOW" >> $GITHUB_OUTPUT

        # Create summary
        TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
        echo "total=$TOTAL" >> $GITHUB_OUTPUT

        if [ $TOTAL -eq 0 ]; then
          echo "status=‚úÖ No vulnerabilities found" >> $GITHUB_OUTPUT
        elif [ $CRITICAL -gt 0 ]; then
          echo "status=üö® Critical vulnerabilities found" >> $GITHUB_OUTPUT
        elif [ $HIGH -gt 0 ]; then
          echo "status=‚ö†Ô∏è High severity vulnerabilities found" >> $GITHUB_OUTPUT
        else
          echo "status=‚ÑπÔ∏è Low/Medium vulnerabilities found" >> $GITHUB_OUTPUT
        fi

    - name: Comment PR with security results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const critical = '${{ steps.security-summary.outputs.critical }}';
          const high = '${{ steps.security-summary.outputs.high }}';
          const medium = '${{ steps.security-summary.outputs.medium }}';
          const low = '${{ steps.security-summary.outputs.low }}';
          const status = '${{ steps.security-summary.outputs.status }}';
          const total = '${{ steps.security-summary.outputs.total }}';

          const body = `## üîí Security Scan Results

          ${status}

          | Severity | Count |
          |----------|-------|
          | üö® Critical | ${critical} |
          | ‚ö†Ô∏è High | ${high} |
          | ‚ö° Medium | ${medium} |
          | ‚ÑπÔ∏è Low | ${low} |
          | **Total** | **${total}** |

          ${parseInt(critical) > 0 || parseInt(high) > 0 ? '‚ö†Ô∏è **Action Required**: Please review and address critical/high severity vulnerabilities before merging.' : '‚úÖ All clear! No critical or high severity vulnerabilities detected.'}

          <details>
          <summary>View detailed report</summary>

          Download the \`pr-security-reports\` artifact from the workflow run for the full OWASP Dependency-Check report.

          </details>`;

          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('üîí Security Scan Results')
          );

          // Update or create comment
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    # PR Summary
    - name: PR Summary
      if: always()
      run: |
        echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Unit Tests: Completed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Integration Tests: Completed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Code Coverage: ‚â• 40%" >> $GITHUB_STEP_SUMMARY
        echo "- üîí Security Scan: ${{ steps.security-summary.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- Java Version: ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.event.pull_request.head.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ All checks passed - ready for review" >> $GITHUB_STEP_SUMMARY
        echo "- After approval and merge, automatic deployment will begin" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test results and coverage reports available in artifacts" >> $GITHUB_STEP_SUMMARY
